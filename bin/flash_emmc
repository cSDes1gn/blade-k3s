#!/bin/bash

OKGREEN='\033[92m'
# WARNING='\033[93m'
FAIL='\033[91m'
OKBLUE='\033[94m'
UNDERLINE='\033[4m'
ENDC='\033[0m'

set -e

if [ $# -ne 1 ]; then
    echo "$0": "usage: ./flash_emmc.sh [ PATH_TO_IMG ]"
    exit 0
fi

img=$1
echo -e "${OKGREEN} Please verify the following: ${ENDC}"
echo " 1. The turingpi is ON"
echo " 2. The turingpi USB flash slave jumper is set"
echo " 3. This local machine is set Slave micro usb flash port is connected to "

read -p "Press any key to continue ..."
echo "Insert compute module into master SO-DIMM slot."
read -p "Press any key to continue ..."

echo "${OKBLUE} Starting eMMC Flashing Service ${ENDC}"

echo "Searching for BCM devices on USB ..."
# FIXME check and fail if BCM device is not found
timeout 15s watch -n 0.1 lsusb
echo -e "${OKGREEN} ✓ ${ENDC} complete"

echo "Sending boot code ..."
cd usbboot
sudo ./rpiboot
cd ..
echo -e "${OKGREEN} ✓ ${ENDC} complete"

timeout 5s watch -n 0.1 diskutil list
read -rp 'Specify disk write location (ie /dev/disk2): ' disk
echo "Unmounting $disk ..."
diskutil unmountDisk "$disk"
echo -e "${OKGREEN} ✓ ${ENDC} complete"
echo "Flashing $img to $disk..."
pv "$img" | sudo dd bs=1m of="$disk"
echo -e "${OKGREEN} ✓ ${ENDC} complete"

echo "Copying public ssh key to buffer ... "
cat ~/.ssh/id_rsa.pub | pbcopy
echo -e "${OKGREEN} ✓ ${ENDC} complete"
echo "Opening node user data ..."
vi /Volumes/HypriotOS/user-data

diskutil unmountDisk "$disk"

echo -e "${OKGREEN} ✓ ${ENDC} Completed eMMC Flashing Service"